<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"> 
    <meta name='apple-mobile-web-app-capable' content='yes' />
    <title>GeoAR demo</title>
    <script src="https://cdn.bootcss.com/three.js/r83/three.js"></script>
    <script type="text/javascript" src="https://webapi.amap.com/maps?v=1.4.15&key=4f0f5594c4e3c4ae3ce67df92638a154"></script> 
</head>

<link rel="stylesheet" href="./index.css">
<link rel="stylesheet" href="./radar.css">

<script src="./screenfull.min.js"></script>
<!--     后置摄像头视频流 -->
<script src="./cameraStream.js"></script>
<!--     航空次序欧拉角 -->
<script src="./deviceorientation.js"></script>
<!--     处理POI和移动设备的相对位置 -->
<script src="./processLocation.js"></script>
    
<body style='margin: 0; overflow: hidden;'>
    <div id='mapcontainer'></div>
    <video class="camerastream"></video>
    <div class="fullscreen">
        <svg t="1574673025727" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1365" width="48" height="48"><path d="M884.392 970.333H671.887c-23.01 0-41.666-18.656-41.666-41.666 0-23.011 18.656-41.667 41.666-41.667h212.505V691.158c0-23.01 18.656-41.666 41.666-41.666 23.011 0 41.667 18.656 41.667 41.666V887c0 45.959-37.395 83.333-83.333 83.333z m-541.667 0H134.391c-45.949 0-83.333-37.374-83.333-83.333V678.667c0-23.011 18.656-41.667 41.667-41.667s41.667 18.656 41.667 41.667V887h208.333c23.01 0 41.666 18.656 41.666 41.667 0 23.01-18.657 41.666-41.666 41.666z m-250-587.504c-23.01 0-41.667-18.656-41.667-41.667V137c0-45.959 37.384-83.333 83.333-83.333h204.163c23.01 0 41.667 18.657 41.667 41.667S361.564 137 338.554 137H134.391v204.162c0 23.011-18.656 41.667-41.666 41.667z m833.333-8.321c-23.01 0-41.666-18.656-41.666-41.666V137H671.887c-23.01 0-41.666-18.656-41.666-41.667s18.656-41.667 41.666-41.667h212.505c45.938 0 83.333 37.374 83.333 83.333v195.842c0 23.011-18.657 41.667-41.667 41.667z" p-id="1366" fill="#ffffff"></path></svg>
        
        <svg t="1574673043864" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1542" width="48" height="48"><path d="M346.9 970.333c-23.03 0-41.667-18.656-41.667-41.667V711.992H92.709c-22.99 0-41.667-18.657-41.667-41.667 0-23.011 18.677-41.667 41.667-41.667h212.524c45.939 0 83.334 37.374 83.334 83.334v216.674c0 23.011-18.677 41.667-41.667 41.667z m324.993-1.078c-23.031 0-41.668-18.656-41.668-41.667V710.913c0-45.959 37.375-83.333 83.334-83.333h212.484c23.029 0 41.666 18.656 41.666 41.667 0 23.01-18.637 41.666-41.666 41.666H713.559v216.675c0 23.011-18.678 41.667-41.666 41.667z m254.15-572.835H713.559c-45.959 0-83.334-37.374-83.334-83.334V96.412c0-23.01 18.637-41.667 41.668-41.667 22.988 0 41.666 18.657 41.666 41.667v216.674h212.484c23.029 0 41.666 18.656 41.666 41.667s-18.637 41.667-41.666 41.667z m-620.81-1.078H92.709c-22.99 0-41.667-18.657-41.667-41.667 0-23.011 18.677-41.667 41.667-41.667h212.524V95.333c0-23.01 18.637-41.667 41.667-41.667 22.99 0 41.667 18.656 41.667 41.667v216.675c0 45.96-37.395 83.334-83.334 83.334z" p-id="1543" fill="#ffffff"></path></svg>
    </div>
    <div class="radarbox">
       <div class="phone">
          <figure class="front-side">
            <div class="screen"></div>
            <div class="camera"></div>
          </figure>
          <figure>
          </figure>
          <figure></figure>
          <figure></figure>
          <figure></figure>
          <figure></figure>
        </div>
    </div>
    <!--     全局变量 -->
    <script src="./store.js"></script>
    <script>

        
        window.onload = () => {

            store.scene = new THREE.Scene();
            store.camera = new THREE.PerspectiveCamera( store.VAOV, window.innerWidth/window.innerHeight, 0.1, 1000 );
            store.renderer.setSize( window.innerWidth, window.innerHeight );
            document.body.appendChild( store.renderer.domElement );
            
            // 位置处理模块
            processLocation('mapcontainer');
            
            // 姿态处理模块
            window.addEventListener(store.eventName, function(event) {
                [yaw,pitch,roll] = getTaitBryanAngles(event);
                // threejs的旋转按照右手定则，和航空次序欧拉角一样都是动轴旋转，
                var euler = new THREE.Euler(pitch*Math.PI/180, -yaw*Math.PI/180, -(roll+window.orientation)*Math.PI/180, 'YXZ');
                store.camera.setRotationFromEuler(euler);
                //css的旋转是定轴旋转：在一次transform的过程中，坐标轴是不变的，也就是说即使先绕x轴转了，y轴依然是指向手机下方的
                // 定轴旋转等同于倒序执行动轴旋转
                //从右向左依次执行变换,rotate旋转是左手定则         
                phoneElement.style.transform = `rotateY(${ - yaw}deg) rotateX(${- pitch}deg) rotateZ(${roll}deg) scale3d(0.075,0.075,0.075)`;

            }, false);
            
            var geometry = new THREE.BoxGeometry( 10, 1, 1 );
            var material = new THREE.MeshBasicMaterial( { color: 0x00ff00 } );
            var cube = new THREE.Mesh( geometry, material );
            cube.position.set(5,0,0);
            cube.rotateY(Math.PI/2);
            store.scene.add( cube );


            var animate = function () {
                requestAnimationFrame( animate );
                store.renderer.render( store.scene, store.camera );
            };

            animate();
            
            const video = document.querySelector('.camerastream');
            videoTrack = getCameraStream(video);
            
            const phoneElement = document.querySelector('.phone');
            const fullscreenElement = document.querySelector('.fullscreen');
            
            // 全屏
            if (screenfull.isEnabled) {
                let classList = fullscreenElement.classList;
                function toggleScreenFull(){
                    screenfull.isFullscreen? classList.remove("exit"):classList.add("exit"); 
                    screenfull.toggle(); 
                }
                fullscreenElement.addEventListener('click', toggleScreenFull);
                // 处理息屏
                var hidden, visibilityChange; 
                if (typeof document.hidden !== "undefined") { // Opera 12.10 and Firefox 18 and later support 
                    hidden = "hidden";
                    visibilityChange = "visibilitychange";
                } else if (typeof document.msHidden !== "undefined") {
                    hidden = "msHidden";
                    visibilityChange = "msvisibilitychange";
                } else if (typeof document.webkitHidden !== "undefined") {
                    hidden = "webkitHidden";
                    visibilityChange = "webkitvisibilitychange";
                }
                document.addEventListener(visibilityChange, () => {
                    screenfull.exit();
                    classList.remove("exit"); 
                }, false);
            }
            
            

        }
        window.onresize = () => {
            // debugger
            // 重新设置相机宽高比例
            store.camera.aspect = window.innerWidth / window.innerHeight;
            // 更新相机投影矩阵
            store.camera.updateProjectionMatrix();
            // 重新设置渲染器渲染范围
            store.renderer.setSize( window.innerWidth, window.innerHeight );
            
            store.constraints.video.aspectRatio = window.innerHeight/window.innerWidth;
            const video = document.querySelector('.camerastream');
            videoTrack = getCameraStream(video);
        }
        
    </script>
</body>
</html>
