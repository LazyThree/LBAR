<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"> 
    <meta name='apple-mobile-web-app-capable' content='yes' />
    <title>GeoAR demo</title>
    <script src="https://cdn.bootcss.com/three.js/r83/three.js"></script>
    <script type="text/javascript" src="https://webapi.amap.com/maps?v=1.4.15&key=4f0f5594c4e3c4ae3ce67df92638a154"></script> 
</head>

<link rel="stylesheet" href="./index.css">
<link rel="stylesheet" href="./radar.css">

<!--     后置摄像头视频流 -->
<script src="./cameraStream.js"></script>
<!--     航空次序欧拉角 -->
<script src="./deviceorientation.js"></script>
<!--     处理POI和移动设备的相对位置 -->
<script src="./processLocation.js"></script>
    
<body style='margin: 0; overflow: hidden;'>
    <div id='mapcontainer'></div>
    <video class="camerastream"></video>
    <div class="radarbox">
       <div class="phone">
          <figure class="front-side">
            <div class="screen"></div>
            <div class="camera"></div>
          </figure>
          <figure>
          </figure>
          <figure></figure>
          <figure></figure>
          <figure></figure>
          <figure></figure>
        </div>
    </div>
    <!--     全局变量 -->
    <script src="./store.js"></script>
    <script>

        
        window.onload = () => {

            store.scene = new THREE.Scene();
            store.camera = new THREE.PerspectiveCamera( store.VAOV, window.innerWidth/window.innerHeight, 0.1, 1000 );
            store.renderer.setSize( window.innerWidth, window.innerHeight );
            document.body.appendChild( store.renderer.domElement );
            const phoneElement = document.querySelector('.phone');   
            
            // 位置处理模块
            processLocation('mapcontainer');
            
            // 姿态处理模块
            window.addEventListener(store.eventName, function(event) {
                [yaw,pitch,roll] = getTaitBryanAngles(event);
                // threejs的旋转按照右手定则，和航空次序欧拉角一样都是动轴旋转，
                var euler = new THREE.Euler(pitch*Math.PI/180, -yaw*Math.PI/180, -(roll+window.orientation)*Math.PI/180, 'YXZ');
                store.camera.setRotationFromEuler(euler);
                //css的旋转是定轴旋转：在一次transform的过程中，坐标轴是不变的，也就是说即使先绕x轴转了，y轴依然是指向手机下方的
                // 定轴旋转等同于倒序执行动轴旋转
                //从右向左依次执行变换,rotate旋转是左手定则         
                phoneElement.style.transform = `rotateY(${ - yaw}deg) rotateX(${- pitch}deg) rotateZ(${roll}deg) scale3d(0.075,0.075,0.075)`;

            }, false);
            
            var geometry = new THREE.BoxGeometry( 10, 1, 1 );
            var material = new THREE.MeshBasicMaterial( { color: 0x00ff00 } );
            var cube = new THREE.Mesh( geometry, material );
            cube.position.set(5,0,0);
            cube.rotateY(Math.PI/2);
            store.scene.add( cube );


            var animate = function () {
                requestAnimationFrame( animate );
                store.renderer.render( store.scene, store.camera );
            };

            animate();
            
            // 视频处理模块
            const video = document.querySelector('.camerastream');
            videoTrack = getCameraStream(video);
              
            
        }
        
    </script>
</body>
</html>
